---
title: "4_Linear_Regression_Cigarettes"
author: "MariaGladkaya"
date: "2023-12-21"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
## Считываем дата-сет

```{r data, fig.width=12, fig.height=9, message=FALSE}
library(readxl)
df <- read_excel("~/spbu_studies/mat_statistics/MatStat4-6/datasets/cigarettes.xlsx")
View(df)
```
## Корреляционный анализ
### g. Построить график рассеяния и уравнения регрессии.

- Под глав. диагональю: графики рассеивания. Попарная зависимость
- Глав. диагон.: гистограммы. Эмпирич. аналог плотности распределения
- Над глав. диагон.: выборочные коэф-ты корреляции (критерий Пирсона)
Н0: Коэф-т кор. = 0 (кор. отсутствует)
``` {r, fig.width=12, fig.height=9, message=FALSE}
library(GGally)
library(ggplot2)
ggpairs(df)
```
### a.Провести корреляционный анализ имеющихся данных.  
#### Матрица корреляции Пирсона
```{r}
ggcorr(df, method = c("everything", "pearson"))
```

#### Проверить значимость можно так же попарно

```{r }
cor.test(df$y, df$x1)
```

## Ур. линейной регрессии и Постороение регрессионной модели 
### b. Построить базовую модель линейной регрессии. 
### c. Вывести результаты анализа базовой модели. 
### d. Записать уравнение линейной регрессии. 
### e. Проверить значимость каждого отдельного коэффициента с помощью  T-test.  
### f. Проверить значимость построенного уравнения регрессии с помощью F-test.  
```{r }
m1 <- lm(y~x1+x2+x3, df)
summary(m1)
```
#### Трактовка:
Выводится *ур. модели линейной регрессии*

*Residuals* - остатки. Разность между наблюдаемым значением и предсказанным. И для них посчитаны квантили

*Coefficients:* 

- Estimate - оценки коэф-тов в ур-нии
- Std. Error, t value - стандартная ошибка и значение статистики Т
- Статистика Стьюдента
    Н0: коэф-т равен 0 (не значим)
      принимаем => не значим
      отвергаем => значим (р < 0.05)
      
*Multiple R-squared:* чем ближе к 1, тем лучше (разброс данных как можно лучше объясняется с пом. построенного ур. лин. регрессии)

**Отвергаем** Н0: ур. лин. регресси не значимо в целом (Все коэф-ты одновременно = 0) => **ур. лин. регресси значимо** 


### h. Построить доверительные интервалы для коэффициентов регрессии.
```{r}
confint(m1)
```
С вероятностью 95% значения переменных попадают в этот интервал 

#### Анализ значимости регресионной модели, построенной только на одной переменной для всех переменных.
```{r}
anova(m1)
```

### i. В случае подозрения на наличие выбросов, проверить так называемые важные наблюдения, которые значительно влияют на построение модели.  
#### Анализ значимости наблюдений
-```{r}
influence.measures(m1)
-```
 
### j. Используя функцию Step или StepAIC, постараться улучшить модель.  
*Start:  AIC=12607.61* - рассмотрим все переменные как объясняющие

Для модели смотрим по переменным, как изменится AIC при удалении(-) или прибавлении(+) той или иной переменной

```{r}
step(m1, direction = "both")
```
В итоге выводится модель, дающая наименьший AIC

```{r}
library(MASS)
stepAIC(m1)
```

### k. В случае получения в предыдущем пункте модели, отличной от базовой, повторить пп. c-i для новой модели. 

```{r}
m2 <- lm(y~x1+x3, df)
summary(m2)
```

```{r}
confint(m2)
```


## Диагностика модели линейной регрессии

### l. Построить графики: scatterplot, "Residuals vs Fitted", "Normal Q-Q" , "Residuals vs Leverage" и дать интерпретации.  

*Residuals vs Fitted* - x - оценки, полученные с пом модели лин регр

                        у - остатки(точки)
                        
*Normal Q-Q* - анализ совместного распр. случайных величин (сопоставляются теор. и эмпир. квантили)

               подчинаяются ли остатки норм. распр.
               
               **Норм распр скорее всего подтвердится при проверке гипотезы**
             
*Residuals vs Leverage* - оценить имеются ли важные значения в выборке (которые существенно изменят модель). Они заходят за Cook's distance

*Scale-Location* - выявить влиятельные значения
```{r, fig.width=12, fig.height=9, message=FALSE}
plot(m2)
```


### m. Проверить модель на наличие выбросов.  
```{r}
library(car)
outlierTest(m2, n.max=5)
```


### n. Проверить модель на гетероскедастичность. 
H0: дисперсии остатков одинаковы (гомоскедастичность) - нет проблемы
H1: дисперсии остатков различны (гетероскедастичность)
```{r}
ncvTest(m2)
```
Принимаем Н0 => гомоскедастичность

```{r}
library(lmtest)
bptest(m2)
```

### o. Проверить остатки модели на автокорреляцию. 

Проверяет зависимость или независимость остатков

```{r}
durbinWatsonTest(m2)
```
H0: p=0 (нет автокорреляции)
р != 0 => есть автокорреляция

```{r}
dwtest(m2)
```

```{r}
dwtest(m2, alternative = "two.sided")
```

### p. Проверить остатки модели на нормальность распределения.  

```{r}
library(olsrr)
ols_test_normality(m2)
```

Остатки должны быть равномерно разбросаны относительно прямой у = 0
```{r}
library(nortest)
res2 <- residuals(m2)
plot(res2)
```

```{r}
lillie.test(res2)
```

```{r}
pearson.test(res2)
```

Харке-Бера проверяет нормальность по моментам
```{r}
library(tseries)
jarque.bera.test(res2)
```

```{r}
ad.test(res2)
```

```{r}
hist(res2)
```

### q. Проверить модель на мультиколлинеарность данных. 
Мультиколлинеарность - линейная зависимость одной независимой переменной от линейной комбинации других переменных

**Проблема мультиколлинеарности не возникает, когда все коэф-ты < 10**

```{r}
ols_vif_tol(m2)
```

### r. Попробовать применить трансформацию Box-Cox зависимой переменной.
Улучшение модели с пом. степенного преобразования зависимой переменной у

```{r, fig.width=9, fig.height=6}
library(MASS)
bc <- boxCox(m2)
```
вертикальные линии показывают точечные значения в которых достигается макс. знач. функции правдоподобия. + доверительный интервал

```{r}
which.max(bc$y)
lambda <- bc$x[which.max(bc$y)]
lambda
```
Максимум функции правдоподобия (2 линия на графике)

Далее возведем зависимую переменную в эту степень

```{r}
z <- df$y^lambda
df2 <- df[, -1]
df2$y <- z
df2
```
```{r}
m3 <- lm(y~x1+x3, df)
summary(m3)
```
summary для m2:

- Multiple R-squared:  0.9741,	Adjusted R-squared:  0.9718 
- F-statistic:   414 on 2 and 22 DF,  p-value: < 2.2e-16

### s. В случае получения новой модели в предыдущем пункте проанализировать новую модель. 

Новая модель не получена



